#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    require __DIR__ . '/../vendor/autoload.php';
} else {
    // System-wide installation
    if (file_exists('/usr/share/php/Symfony/Component/Console/autoload.php')) {
        require_once '/usr/share/php/Symfony/Component/Console/autoload.php';
        require_once '/usr/share/php/Symfony/Component/Dotenv/autoload.php';
        require_once '/usr/share/php/Symfony/Component/DependencyInjection/autoload.php';
        require_once '/usr/share/php/Symfony/Component/Yaml/autoload.php';
    }

    // AbraFlexi & EaseCore fallback
    foreach (['AbraFlexi', 'Ease', 'Vitexsoftware/AbraflexiCli'] as $namespace) {
        spl_autoload_register(function ($class) {
            $prefix = 'Vitexsoftware\\AbraflexiCli\\';
            $base_dir = __DIR__ . '/../src/';
            $len = strlen($prefix);
            if (strncmp($prefix, $class, $len) === 0) {
                $relative_class = substr($class, $len);
                $file = $base_dir . str_replace('\\', '/', $relative_class) . '.php';
                if (file_exists($file)) {
                    require $file;
                }
            }
        });
    }
}

use Symfony\Component\Console\Application;
use Symfony\Component\Dotenv\Dotenv;
use Vitexsoftware\AbraflexiCli\Command\ListCompaniesCommand;
use Vitexsoftware\AbraflexiCli\Command\ListEvidencesCommand;
use Vitexsoftware\AbraflexiCli\Command\RecordCommand;

if (file_exists(__DIR__ . '/../.env')) {
    (new Dotenv())->usePutenv()->load(__DIR__ . '/../.env');
}

$application = new Application('AbraFlexi CLI', '0.1.0');

$application->addCommand(new ListCompaniesCommand());
$application->addCommand(new ListEvidencesCommand());
$application->addCommand(new RecordCommand());

$application->run();
